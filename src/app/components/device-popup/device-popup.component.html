<div class="popup-overlay" *ngIf="isVisible" (click)="closePopup()"></div>
<div class="device-popup" *ngIf="isVisible">
  <div class="popup-header">
    <h3>{{ getPopupTitle() }}</h3>
    <button class="popup-close" (click)="closePopup()">&times;</button>
  </div>
  
  <div class="popup-content">
    <!-- Device List View (default) -->
    <div *ngIf="!isShowingDeviceDetails">
      <div class="subnet-stats-grid" *ngIf="currentSubnet">
        <div class="stat-item">
          <span class="stat-label">Total Devices:</span>
          <span class="stat-value">{{(currentSubnet.deviceCount || 0) | number}}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Risk Score:</span>
          <span class="stat-value">{{(currentSubnet.riskScore || 0) | number:'1.2-2'}}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Risk Level:</span>
          <span class="stat-value" [ngClass]="'risk-' + (currentSubnet.riskLevel || 'unknown')">
            {{(currentSubnet.riskLevel || 'UNKNOWN').toUpperCase()}}
          </span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Vulnerable:</span>
          <span class="stat-value" [ngClass]="currentSubnet.isVulnerable ? 'vulnerable' : 'safe'">
            {{currentSubnet.isVulnerable ? 'YES' : 'NO'}}
          </span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Network Size:</span>
          <span class="stat-value">/{{currentSubnet.networkSize || 24}}</span>
        </div>
      </div>

      <div class="device-header">
        <h4>Connected Devices: <span>{{currentSubnet?.devices?.length || 0}}</span></h4>
        <div class="device-actions">
          <button (click)="showDeviceTable()" class="table-btn">View All in Table</button>
          <button class="device-action-btn export-btn" (click)="exportDeviceList()">
            Export CSV
          </button>
        </div>
      </div>

      <!-- Device controls and grid (existing content) -->
      <div class="device-controls" *ngIf="(currentSubnet?.devices?.length || 0) > 0">
        <input 
          type="text" 
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          placeholder="Search devices by name, IP, type..."
          class="device-search-input">
        
        <select [(ngModel)]="filterType" (change)="onFilterChange()" class="device-filter-select">
          <option value="all">All Devices</option>
          <option value="critical">Critical Risk (8.0+)</option>
          <option value="high">High Risk (6.0-7.9)</option>
          <option value="medium">Medium Risk (4.0-5.9)</option>
          <option value="low">Low Risk (<4.0)</option>
          <option value="vulnerable">With Vulnerabilities</option>
          <option value="servers">Servers Only</option>
          <option value="workstations">Workstations Only</option>
        </select>
        
        <select [(ngModel)]="sortType" (change)="onSortChange()" class="device-sort-select">
          <option value="threat-desc">Sort by Risk (High-Low)</option>
          <option value="threat-asc">Sort by Risk (Low-High)</option>
          <option value="name-asc">Sort by Name (A-Z)</option>
          <option value="name-desc">Sort by Name (Z-A)</option>
          <option value="ip-asc">Sort by IP</option>
          <option value="type-asc">Sort by Type</option>
        </select>
      </div>

      <div class="device-container">
        <!-- Loading State -->
        <div *ngIf="isLoading" class="text-center" style="padding: 40px;">
          <div class="loading-spinner"></div>
          <h4>Discovering All Network Devices</h4>
          <p><strong>Current step:</strong> {{loadingMessage}}</p>
          <p>Subnet: <strong>{{currentSubnet?.subnet}}</strong></p>
          <p>Expanding ALL nodes progressively...</p>
          <p>This may take 30-60 seconds to discover all devices</p>
          <p style="font-size: 12px; color: #666;">Reading from: ISIM backend via API</p>
        </div>

        <!-- No Devices Available -->
        <div *ngIf="hasNoDevices" class="no-devices-message">
          <div class="no-devices-icon"></div>
          <h5>No Device Data Available</h5>
          <p>Device information will appear here once your ISIM backend includes device relationships.</p>
          <p>Current subnet data is from CIDR analysis.</p>
        </div>

        <!-- Device Grid -->
        <div class="device-grid" *ngIf="showDeviceGrid">
          <div 
            *ngFor="let device of paginatedDevices" 
            class="device-card"
            [ngClass]="getRiskClass(device.riskScore || 0)"
            (click)="onDeviceClick(device)"
            (mouseenter)="showDeviceTooltip($event, device)"
            (mouseleave)="hideTooltip()">
            
            <div class="device-card-header">
              <div class="device-hostname">{{device.hostname || 'Unknown Host'}}</div>
              <div class="device-threat-badge" [ngClass]="getRiskBadgeClass(device.riskScore || 0)">
                <span *ngIf="device.hasRiskScore !== false">{{(device.riskScore || 0) | number:'1.1-1'}}</span>
                <span *ngIf="device.hasRiskScore === false" style="font-size: 9px;">NO SCORE</span>
              </div>
            </div>
            
            <div class="device-details">
              <strong>IP:</strong> {{device.ip || 'N/A'}} | <strong>Type:</strong> {{device.deviceType || 'Unknown'}}
            </div>
            
            <div class="device-details">
              <strong>OS:</strong> {{device.os || 'Unknown'}}
            </div>
            
            <div class="device-vulnerabilities" *ngIf="device.vulnerabilities && device.vulnerabilities.length > 0">
              <span class="vulnerability-warning">⚠ {{device.vulnerabilities.length}} vulnerabilities</span>
            </div>
          </div>
        </div>

        <div class="device-pagination" *ngIf="showDeviceGrid && totalPages > 1">
          <div class="device-pagination-controls">
            <button 
              class="device-pagination-btn" 
              (click)="goToPage(currentPage - 1)"
              [disabled]="currentPage <= 1">
              Previous
            </button>
            
            <span class="device-pagination-info">{{paginationInfo}}</span>
            
            <button 
              class="device-pagination-btn" 
              (click)="goToPage(currentPage + 1)"
              [disabled]="currentPage >= totalPages">
              Next
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Device Details View -->
    <div *ngIf="isShowingDeviceDetails && selectedDevice">
      <div class="breadcrumb">
        <a (click)="backToDeviceList()" style="cursor: pointer; color: #007bff;">Back to Device List</a> > 
        <strong>{{selectedDevice.hostname || 'Unknown'}} ({{selectedDevice.ip || 'N/A'}})</strong>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div>
          <h4>Device Information</h4>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
            <p><strong>Hostname:</strong> {{selectedDevice.hostname || 'Unknown'}}</p>
            <p><strong>IP Address:</strong> {{selectedDevice.ip || 'N/A'}}</p>
            <p><strong>Device Type:</strong> {{selectedDevice.deviceType || 'Unknown'}}</p>
            <p><strong>Operating System:</strong> {{selectedDevice.os || 'Unknown'}}</p>
            <p><strong>Status:</strong> 
              <span [ngClass]="'status-' + getDeviceStatus(selectedDevice).toLowerCase()">
                {{getDeviceStatus(selectedDevice) || 'Unknown'}}
              </span>
            </p>
            <p><strong>Last Seen:</strong> {{getDeviceLastSeen(selectedDevice) || 'Unknown'}}</p>
            <p><strong>Source:</strong> ISIM Database</p>
          </div>
        </div>
        
        <div>
          <h4>Security Information</h4>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
            <p><strong>Risk Score:</strong> 
              <span *ngIf="selectedDevice.hasRiskScore !== false" [ngClass]="'risk-' + getRiskClass(selectedDevice.riskScore || 0)">
                {{(selectedDevice.riskScore || 0) | number:'1.2-2'}} / 10.0
              </span>
              <span *ngIf="selectedDevice.hasRiskScore === false" style="color: #666; font-style: italic;">
                No risk score available (0.0) - Missing ISIM data
              </span>
            </p>
            <p><strong>Risk Level:</strong> 
              <span [ngClass]="'risk-' + getRiskClass(selectedDevice.riskScore || 0)">
                {{getRiskClass(selectedDevice.riskScore || 0).toUpperCase()}}
              </span>
            </p>
            <p><strong>Vulnerabilities:</strong> {{selectedDevice.vulnerabilities.length || 0}}</p>
            <p><strong>Open Ports:</strong> {{getDeviceOpenPorts(selectedDevice) || 'N/A'}}</p>
          </div>
        </div>
      </div>
      
      <div *ngIf="selectedDevice.vulnerabilities && selectedDevice.vulnerabilities.length > 0" style="margin-top: 20px;">
        <h4>Vulnerabilities Found ({{selectedDevice.vulnerabilities.length}})</h4>
        <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107; max-height: 200px; overflow-y: auto;">
          <p *ngFor="let vuln of selectedDevice.vulnerabilities" style="margin: 5px 0;">• {{vuln}}</p>
        </div>
      </div>
      
      <div *ngIf="!selectedDevice.vulnerabilities || selectedDevice.vulnerabilities.length === 0" style="margin-top: 20px;">
        <h4>Vulnerabilities</h4>
        <div style="background: #d4edda; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
          <p style="margin: 0; color: #155724;">✓ No known vulnerabilities detected</p>
        </div>
      </div>
      
      <div style="margin-top: 20px; text-align: center;">
        <button (click)="backToDeviceList()" class="popup-close-btn" style="background: #6c757d; margin-right: 10px;">
          ← Back to Device List
        </button>
        <button (click)="closePopup()" class="popup-close-btn">
          Close
        </button>
      </div>
    </div>

    <div class="popup-footer" *ngIf="!isShowingDeviceDetails">
      <button class="popup-close-btn" (click)="closePopup()">Close</button>
    </div>
  </div>
</div>